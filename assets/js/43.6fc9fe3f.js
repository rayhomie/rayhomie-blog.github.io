(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{390:function(t,a,s){"use strict";s.r(a);var n=s(42),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"从零搭建gitlabci环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#从零搭建gitlabci环境"}},[t._v("#")]),t._v(" 从零搭建gitlabci环境")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.bilibili.com/video/BV1iv41177zU",target:"_blank",rel:"noopener noreferrer"}},[t._v("学习途径"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"搭建环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建环境"}},[t._v("#")]),t._v(" 搭建环境")]),t._v(" "),s("p",[t._v("将gitlab镜像拉到服务器上跑起来。")]),t._v(" "),s("h3",{attrs:{id:"_1】拉取镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1】拉取镜像"}},[t._v("#")]),t._v(" 1】拉取镜像")]),t._v(" "),s("ul",[s("li",[t._v("使用docker拉取"),s("code",[t._v("gitlab/gitlab-ce")]),t._v("的镜像")]),t._v(" "),s("li",[t._v("docker拉取"),s("code",[t._v("nginx")]),t._v("镜像")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查看本地镜像")]),t._v("\ndocker images\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#从远程仓库拉取gitlab/gitlab-ce的镜像")]),t._v("\ndocker pull gitlab/gitlab-ce\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#从远程仓库拉取nginx镜像")]),t._v("\ndocker pull nginx\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker images\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#REPOSITORY         TAG       IMAGE ID       CREATED      SIZE")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#node               latest    8f1b7f0dfc2f   5 days ago   907MB")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#nginx              latest    08b152afcfae   5 days ago   133MB")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#gitlab/gitlab-ce   latest    75d591b81fd7   6 days ago   2.23GB")]),t._v("\n")])])]),s("h3",{attrs:{id:"_2】运行镜像到容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2】运行镜像到容器"}},[t._v("#")]),t._v(" 2】运行镜像到容器")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker run --detach --hostname gitlab.rayhomie.icu --publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(":443 --publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 --publish "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("222")]),t._v(":22 --name gitlab --restart always --volume /srv/gitlab/config:/etc/gitlab --volume /srv/gitlab/logs:/var/log/gitlab --volume /srv/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:latest\n")])])]),s("h3",{attrs:{id:"_3】查看当前运行的容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3】查看当前运行的容器"}},[t._v("#")]),t._v(" 3】查看当前运行的容器")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker container "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" -a\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#CONTAINER ID   IMAGE                     COMMAND             CREATED         STATUS    PORTS     NAMES")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#df62d4c44c25   gitlab/gitlab-ce:latest   "/assets/wrapper"   3 minutes ago   Created             gitlab')]),t._v("\n")])])]),s("h3",{attrs:{id:"_4】查看容器名为gitlab的日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4】查看容器名为gitlab的日志"}},[t._v("#")]),t._v(" 4】查看容器名为gitlab的日志")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#打印当前运行日志")]),t._v("\ndocker logs gitlab\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#实时打印日志")]),t._v("\ndocker logs -f gitlab\n")])])]),s("h3",{attrs:{id:"_5】成功运行gitlab"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5】成功运行gitlab"}},[t._v("#")]),t._v(" 5】成功运行gitlab")]),t._v(" "),s("p",[t._v("此时我们就成功地将gitlab镜像跑在了本地的docker容器中，并且可以通过地址来访问gitlab界面。")]),t._v(" "),s("h2",{attrs:{id:"gitlab-ci-cd基础知识"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-cd基础知识"}},[t._v("#")]),t._v(" GitLab CI/CD基础知识")]),t._v(" "),s("p",[t._v("简单理解：但我们把本地代码推到gitlab远程仓库时，会触发一个流程，这个流程会执行一系列的任务，这些任务组装起来就是一个pipeline（流水线）。")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("pipeline")]),t._v("（流水线）")]),t._v(" "),s("li",[s("strong",[t._v("stage")]),t._v("（阶段）")]),t._v(" "),s("li",[s("strong",[t._v("job")]),t._v("（任务）")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/e67ebcaeeac14e8e92c43db4b8c43a90.png",alt:"gitlabcicd概念"}})]),t._v(" "),s("p",[t._v("如上图可以看出这几个概念之间的关系是：")]),t._v(" "),s("ul",[s("li",[t._v("一个"),s("strong",[t._v("流水线")]),t._v("包含多个"),s("strong",[t._v("阶段")]),t._v("；")]),t._v(" "),s("li",[t._v("一个"),s("strong",[t._v("阶段")]),t._v("包含多个"),s("strong",[t._v("任务")]),t._v("；")])]),t._v(" "),s("p",[t._v("gitlab只是一个代码仓库（代码管理工具平台），它是不会去跑这些流水线上的任务。所以又要引出一个概念"),s("strong",[t._v("gitlab runner")]),t._v("（一个安装在服务器上的软件），所有的我们定义的cicd的操作都是在gitlab runner上去跑。（gitlab runner就是给cicd提供一个环境）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v(".gitlab-ci.yml")]),t._v("文件：用来定义流水线、阶段、任务。")])]),t._v(" "),s("h2",{attrs:{id:"docker安装gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker安装gitlab-runner"}},[t._v("#")]),t._v(" docker安装GitLab Runner")]),t._v(" "),s("h3",{attrs:{id:"_1】拉取runner镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1】拉取runner镜像"}},[t._v("#")]),t._v(" 1】拉取runner镜像")]),t._v(" "),s("p",[t._v("在docker远程仓库拉取gitlab/gitlab-runner镜像到本地：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#拉取镜像到本地")]),t._v("\ndocker pull gitlab/gitlab-runner\n")])])]),s("h3",{attrs:{id:"_2】运行镜像到容器-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2】运行镜像到容器-2"}},[t._v("#")]),t._v(" 2】运行镜像到容器")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker run -d --name gitlab-runner --restart always -v /srv/gitlab-runner/config:/etc/gitlab-runner -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:latest\n")])])]),s("h3",{attrs:{id:"_3】注册gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3】注册gitlab-runner"}},[t._v("#")]),t._v(" 3】注册gitlab runner")]),t._v(" "),s("p",[t._v("要使gitlab runner和gitlab产生联系，需要找到我们gitlab的"),s("strong",[t._v("Token")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/ded7b9fce6b4470786316e3284bd80f7.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"token"}})]),t._v(" "),s("p",[t._v("然后在gitlab runner运行的docker容器中用这个Token去注册一下，脚本具体如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker run --rm -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register --non-interactive --executor "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" --docker-image alpine:latest --url "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://gitlab.xxxx.com/"')]),t._v(" --registration-token "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vtizNrFzQKFacsSMxsJX"')]),t._v(" --description "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v(" --tag-list "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test-cicd,dockercicd"')]),t._v(" --run-untagged"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" --locked"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v(" --access-level"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not_protected"')]),t._v("\n")])])]),s("ul",[s("li",[t._v("url参数是我们gitlab的地址")]),t._v(" "),s("li",[t._v("registration-token参数是上图gitlab的token")]),t._v(" "),s("li",[t._v("tag-list参数是注册这个runner的标签（后面可用于指定具体哪个runner去执行流水线任务）")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/32b8717e7f8644c6bdd5b2096b94b4a2.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"runner"}})]),t._v(" "),s("h2",{attrs:{id:"gitlab-ci-yml的编写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-yml的编写"}},[t._v("#")]),t._v(" .gitlab-ci.yml的编写")]),t._v(" "),s("h3",{attrs:{id:"基本关键词使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本关键词使用"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://blog.csdn.net/github_35631540/article/details/111029151",target:"_blank",rel:"noopener noreferrer"}},[t._v("基本关键词使用"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1)]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#script",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("script")]),s("OutboundLink")],1),t._v("：让gitlab runner去执行shell脚本（所有的任务都需要有script关键字去执行）")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#stages",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("stages")]),s("OutboundLink")],1),t._v("：全局自定义阶段")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#stage",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("stage")]),s("OutboundLink")],1),t._v("：在每个"),s("strong",[t._v("job（任务）中定义")]),t._v("该任务属于哪个stage阶段。stage 是阶段的意思，用于归档一部分的job，按照定义的stage顺序来执行。（默认的stage有"),s("code",[t._v(".pre")]),t._v("，"),s("code",[t._v("build")]),t._v("，"),s("code",[t._v("test")]),t._v("，"),s("code",[t._v("deploy")]),t._v("，"),s("code",[t._v(".post")]),t._v("）job执行的顺序不是按照编写的顺序，大体上是按照stage定义的顺序来执行的,注意是大体，也有例外的情况。")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#retry",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("retry")]),s("OutboundLink")],1),t._v("：有可能这个任务会失败，需要有个重试的机制（"),s("code",[t._v("retry:2")]),t._v("指定如果失败重试2次，最多设置为重试2次，也就是最多运行3次）")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#image",target:"_blank",rel:"noopener noreferrer"}},[t._v("image"),s("OutboundLink")],1),t._v("：指定一个基础Docker镜像作为基础运行环境，经常用到的镜像有node、java、python、docker")]),t._v(" "),s("li",[s("strong",[t._v("tags")]),t._v("："),s("strong",[t._v("tags 关键词是用于指定Runner")]),t._v("，tags的取值范围是在该项目可见的runner tags中")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#only--except",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("only")]),s("OutboundLink")],1),t._v("、except：限定当前任务执行的条件（限定分支等）")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#when",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("when")]),s("OutboundLink")],1),t._v("：when关键词是实现在发生故障或尽管发生故障时仍能运行的作业，比如你要在任务失败后需要出发一个job，或者你需要手动执行任务，或者当你一个任务执行成功后，执行另一个任务。\n"),s("ul",[s("li",[t._v("on_success：所有任务执行成功后")]),t._v(" "),s("li",[t._v("on_failure：当至少一个任务失败后")]),t._v(" "),s("li",[t._v("always：执行作业，而不考虑作业在早期阶段的状态")]),t._v(" "),s("li",[t._v("manual：手动执行任务")]),t._v(" "),s("li",[t._v("delayed：延迟执行任务")]),t._v(" "),s("li",[t._v("never：在"),s("code",[t._v("rules")]),t._v("中不排除执行的任务，在"),s("code",[t._v("workflow:rules")]),t._v("不允许的流水线")])])]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/index.html#cache",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("cache")]),s("OutboundLink")],1),t._v("：把一些文件列表保存到缓存中，在各个任务之间互相传递。缓存是将当前工作环境目录中的一些文件，一些文件夹存储起来，用于在各个任务初始化的时候恢复")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/yaml/#artifacts",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[t._v("artifacts")]),s("OutboundLink")],1),t._v("：成功时附加到作业的文件和目录列表。")]),t._v(" "),s("li",[s("strong",[t._v("variables")]),t._v("：在.gitlab-ci.yml文件中定义全局变量或者局部变量。（在全局定义即全局变量，在任务中单独定义即局部变量）")]),t._v(" "),s("li",[t._v("release：自动化发布包")]),t._v(" "),s("li",[t._v("timeout：设置超时时间")]),t._v(" "),s("li",[t._v("resource_group：确保一个分支同时只有一个流水线在工作")]),t._v(" "),s("li",[t._v("after_script")]),t._v(" "),s("li",[t._v("allow_failure")]),t._v(" "),s("li",[t._v("before_script")]),t._v(" "),s("li",[t._v("coverage")]),t._v(" "),s("li",[t._v("dependencies")]),t._v(" "),s("li",[t._v("environment")]),t._v(" "),s("li",[t._v("extends")]),t._v(" "),s("li",[t._v("include")]),t._v(" "),s("li",[t._v("interruptible")]),t._v(" "),s("li",[t._v("pages")]),t._v(" "),s("li",[t._v("parallel")]),t._v(" "),s("li",[t._v("rules")]),t._v(" "),s("li",[t._v("services")]),t._v(" "),s("li",[t._v("trigger")])]),t._v(" "),s("h3",{attrs:{id:"stage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#stage"}},[t._v("#")]),t._v(" stage")]),t._v(" "),s("p",[t._v("由于"),s("code",[t._v("build")]),t._v("在"),s("code",[t._v("test")]),t._v("之前所有会先指向"),s("code",[t._v("job1")]),t._v("这个任务，后指向"),s("code",[t._v("job0")]),t._v("任务：（下面👇：）")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\njob 0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" echo 'tets'\n\njob 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" echo 'build'\n")])])]),s("p",[t._v("下面写了一个默认官方提供stage的案例，含5个jobs属于5个阶段：")]),t._v(" "),s("p",[t._v("官方默认的阶段stages顺序是"),s("code",[t._v(".pre")]),t._v("，"),s("code",[t._v("build")]),t._v("，"),s("code",[t._v("test")]),t._v("，"),s("code",[t._v("deploy")]),t._v("，"),s("code",[t._v(".post")])]),t._v(" "),s("p",[t._v("默认的gitlab runner在同一个阶段的任务是按顺序同步执行的（如果需要他每个阶段任务并发执行的话，需要对gitlab runner进行配置）")]),t._v(" "),s("p",[t._v("所以我们任务的执行顺序是：job1 -> job2 -> job4 -> job6 -> job3 -> job5")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" .pre\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" .post\n\njob 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .pre\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo '.pre job'\n\njob 2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'build job'\n\njob 3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'deploy job'\n   \njob 4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'test1 job'\n    \njob 5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .post\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo '.post job'\n   \njob 6"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'test2 job'\n    \n")])])]),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/9591e288aa8f48489e9d714240d9eaae.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"请添加图片描述"}})]),t._v(" "),s("h3",{attrs:{id:"cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache"}},[t._v("#")]),t._v(" cache")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node:12.6.0'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  stage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("install\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  stage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build\n  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  stage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start deploy'\n")])])]),s("p",[t._v("此时跑流水线的话，在build阶段会报错，因为在第一个阶段的任务结束时会将node_modules文件夹删除掉，此时我们就需要使用缓存将node_modules文件夹进行缓存，缓存的文件夹才可以在各个任务中一直被使用。")]),t._v(" "),s("p",[t._v("（"),s("strong",[t._v("yml文件中的 “-” 和 “:”之后一定要留下空格")]),t._v("）")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node:12.6.0'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#缓存node_modules文件夹，并指定唯一标识key")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" hello"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ci\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build\n  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start deploy'\n")])])]),s("p",[t._v("此时我们可以看到我们的pipeline流水线已经成功执行完成：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/5383daa973c14ea4a67ee9cf6966e67f.png",alt:"pipline"}})]),t._v(" "),s("h4",{attrs:{id:"job-install"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#job-install"}},[t._v("#")]),t._v(" job_install")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/f18661b1b5a546da8b7368b0b881d26f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"install"}})]),t._v(" "),s("h4",{attrs:{id:"job-build"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#job-build"}},[t._v("#")]),t._v(" job_build")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/bbb3beea62eb4447a910ff251404a708.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"build"}})]),t._v(" "),s("h4",{attrs:{id:"job-deploy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#job-deploy"}},[t._v("#")]),t._v(" job_deploy")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/84b614313ed24a499bac8d09e6dbdd44.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"deploy"}})]),t._v(" "),s("h3",{attrs:{id:"only、when"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#only、when"}},[t._v("#")]),t._v(" only、when")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node:12.6.0'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#缓存node_modules文件夹，并指定唯一标识key")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" hello"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ci\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#限定在release分支执行")]),t._v("\n  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner001\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start deploy'\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#手动执行任务")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/0aba7a82b9244c1b9db2bb9f53cf78f7.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"only"}})]),t._v(" "),s("h2",{attrs:{id:"docker部署前端项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker部署前端项目"}},[t._v("#")]),t._v(" docker部署前端项目")]),t._v(" "),s("h3",{attrs:{id:"任务列表："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#任务列表："}},[t._v("#")]),t._v(" 任务列表：")]),t._v(" "),s("ol",[s("li",[t._v("安装node包")]),t._v(" "),s("li",[t._v("编译")]),t._v(" "),s("li",[t._v("docker镜像部署")])]),t._v(" "),s("p",[t._v("使用的关键词有：image，stages，stage，tag，script，cache，docker，build")]),t._v(" "),s("h3",{attrs:{id:"编写dockerfile："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写dockerfile："}},[t._v("#")]),t._v(" 编写Dockerfile：")]),t._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("lastest as builder\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" package.json .\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry=http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm run build\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" ngins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("lastest\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("from=builder /app/dist /usr/share/nginx/html\n")])])]),s("h3",{attrs:{id:"编写-gitlab-ci-yml："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写-gitlab-ci-yml："}},[t._v("#")]),t._v(" 编写.gitlab-ci.yml：")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置node为基础环境镜像")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#声明阶段")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" lint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("code\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置缓存")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" xd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("platform\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义install任务(1.选定阶段、2.runner的tags、3.脚本)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_install")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("001")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义build任务(artifacts是将dist目录存储起来，让其他任务中也能使用到。因为每个任务之间都是隔离的，任务开始时都会重置环境，因此就需要使用cache、artifacts等关键字)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("001")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dist/\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义deploy任务(1.使用docker基础镜像，2.通过dockerfile构建镜像，3.如果环境中有容器则删除该容器并起动运行一个容器，4.且设置为手动执行任务)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("001")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t xd_log_platform_images .\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" $(docker ps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("filter name=xd_log_platform_container) "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(";then docker rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f xd_log_platform_container;\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 8001"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("80 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name xd_log_platform_container xd_log_platform_images\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'deploy docker image success. visit http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//123.23.23.13"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("8001 '\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n")])])]),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/d63bc0019f044d0fa69faf58d8edd92b.png",alt:"gitlabci"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/47ba029a3848455f8593b1a21f0bbbb6.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"gitlabci"}})]),t._v(" "),s("p",[t._v("如果发现报错，可能是gitlab-runner的配置有问题：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#进入gitlab-runner的配置目录")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /srv/gitlab-runner/config\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#编辑配置文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" config.toml\n")])])]),s("p",[t._v("打开编辑页面后你会发现有很多配置项：")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#允许当前阶段几个任务并行执行")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("concurrent")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#代码提交后多久检测一次代码变更，执行gitlab-ci")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("check_interval")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#下面就是该机器上的所有gitlab-runner的配置")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("name")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dev-runner-001"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("url")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxx"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("token")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxx"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("executor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.custom_build_dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache.s3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache.gcs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache.azure")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.docker")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("tls_verify")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("image")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alpine:latest"')]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("privileged")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("disable_entrypoint_overwrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("oom_kill_disable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("disable_cache")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#映射")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("volumes")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#如果docker执行有问题需要设置一下官方提供的目录映射")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#volumes = ["/cache","/usr/bin/docker:/usr/bin/docker","/var/run/docker.sock:/var/run/docker.sock"]')]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("shm_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),s("h2",{attrs:{id:"oss部署前端项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#oss部署前端项目"}},[t._v("#")]),t._v(" oss部署前端项目")]),t._v(" "),s("h3",{attrs:{id:"任务列表：-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#任务列表：-2"}},[t._v("#")]),t._v(" 任务列表：")]),t._v(" "),s("ol",[s("li",[t._v("开题oss")]),t._v(" "),s("li",[t._v("创建bucket")]),t._v(" "),s("li",[t._v("创建ack密钥")]),t._v(" "),s("li",[t._v("使用ossutil")]),t._v(" "),s("li",[t._v("隐秘信息变量存储")])]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#...")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy_oss")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("001")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" wget http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//gosspublic.alicdn.com/ossutil/1.6.18/ossutil64\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chomd 755 ossutil64\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./ossutil64 config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("e $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("endPoint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("accessKeyID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("k $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("accessKeySecret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("L CH "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("loglevel debug "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c ~/.ossutilconfig\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./ossutil64 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("c ~/.ossutilconfig cp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("r "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f dist oss"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//bucket_name/\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n")])])]),s("p",[t._v("指定oss配置文件，递归强制上传dist文件夹下的文件到指定的oss的bucket上。")]),t._v(" "),s("h3",{attrs:{id:"ci环境变量的使用："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ci环境变量的使用："}},[t._v("#")]),t._v(" ci环境变量的使用：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/af10fd258208457cade6c7243f438196.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"ci环境变量"}})]),t._v(" "),s("p",[t._v("通过这样设置了的环境变量值，就可以在**.gitlab-ci.yml**文件中通过"),s("code",[t._v("${variables}")]),t._v("的形式进行使用变量。")]),t._v(" "),s("h2",{attrs:{id:"变量的注入与使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#变量的注入与使用"}},[t._v("#")]),t._v(" 变量的注入与使用")]),t._v(" "),s("p",[t._v("但我们.gitlab.yml文件中有很多地方使用到了相同的值，我们就可以将这些值提取成变量来使用。")]),t._v(" "),s("h3",{attrs:{id:"三种变量的使用："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三种变量的使用："}},[t._v("#")]),t._v(" 三种变量的使用：")]),t._v(" "),s("ul",[s("li",[t._v("在.gitlab-ci.yml中自己定义（variables关键字）")]),t._v(" "),s("li",[t._v("pipeline中"),s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("预定义的变量"),s("OutboundLink")],1),t._v("（提交的commit的哈希值，当前的分支，当前的任务名称等）")]),t._v(" "),s("li",[t._v("自己在项目中设置变量（在可视化页面中进行设置）")])]),t._v(" "),s("h3",{attrs:{id:"变量的类型："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#变量的类型："}},[t._v("#")]),t._v(" 变量的类型：")]),t._v(" "),s("ul",[s("li",[t._v("k-v变量")]),t._v(" "),s("li",[t._v("文件（签名证书，密钥等）")])]),t._v(" "),s("h3",{attrs:{id:"变量能在哪些关键字中使用："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#变量能在哪些关键字中使用："}},[t._v("#")]),t._v(" 变量能在哪些关键字中使用：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("environment:url")])]),t._v(" "),s("li",[s("code",[t._v("environment:name")])]),t._v(" "),s("li",[s("code",[t._v("resource_group")])]),t._v(" "),s("li",[s("code",[t._v("include")])]),t._v(" "),s("li",[s("code",[t._v("variables")])]),t._v(" "),s("li",[s("code",[t._v("image")])]),t._v(" "),s("li",[s("code",[t._v("services:[]")])]),t._v(" "),s("li",[s("code",[t._v("services:[]:name")])]),t._v(" "),s("li",[s("code",[t._v("cache:key")])]),t._v(" "),s("li",[s("code",[t._v("artifacts:name")])]),t._v(" "),s("li",[s("code",[t._v("script,before_script,after_script")])]),t._v(" "),s("li",[s("code",[t._v("only:variables:[],export:variables:[],rules:if")])])]),t._v(" "),s("h3",{attrs:{id:"如何使用："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何使用："}},[t._v("#")]),t._v(" 如何使用：")]),t._v(" "),s("h4",{attrs:{id:"variables关键字定义及使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#variables关键字定义及使用"}},[t._v("#")]),t._v(" variables关键字定义及使用")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#是一个全局的变量，任何一个任务中都可以使用。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("TEST_VAR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"All jobs can use this variable\'s value"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#在任务中执行打印变量（直接用$符号+变量名即可）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("log_var")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $TEST_VAR\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#这是我们刚才使用docker部署前端项目中的任务，我们想要把当前任务中的镜像名称和容器名称定义成局部变量：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("IMAGE_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xd_log_platform_images"')]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("CONTAINER_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xd_log_platform_container"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("001")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $IMAGE_NAME .\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" $(docker ps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("filter name=$CONTAINER_NAME) "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(";then docker rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f $CONTAINER_NAME;\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 8001"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("80 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name $CONTAINER_NAME $IMAGE_NAME\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'deploy docker image success. visit http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//123.23.23.13"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("8001 '\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n")])])]),s("h4",{attrs:{id:"在可视化页面设置变量并使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在可视化页面设置变量并使用"}},[t._v("#")]),t._v(" 在可视化页面设置变量并使用")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/88222198a86c46739a37796d6e8e8223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"变量的使用"}})]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#打印我们上面👆设置的NAME变量")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("log_project_var")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $NAME\n")])])]),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/84d83a9ef3d744f1adf44420a4c8b758.png",alt:"nomask"}})]),t._v(" "),s("p",[t._v("勾选mask variable时的打印效果如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/23fe4271a2bd427a9aeb22004a18c70d.png",alt:"mask"}})]),t._v(" "),s("h4",{attrs:{id:"pipeline中预定义的变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pipeline中预定义的变量"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("pipeline中预定义的变量"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("可在官网去"),s("strong",[t._v("查看预定义的变量名")]),t._v("，但是我们怎么去查看到这些预定义变量呢？👇")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#我们可以使用该任务去导出所有的变量（即打印出来）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("get_all_var")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#当前任务就是使用预设变量的例子")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test_variable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $CI_JOB_STAGE\n")])])]),s("h2",{attrs:{id:"流水线的类型以及流水线的触发方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流水线的类型以及流水线的触发方式"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://www.bilibili.com/video/BV1Z64y1r7m9",target:"_blank",rel:"noopener noreferrer"}},[t._v("流水线的类型以及流水线的触发方式"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"流水线类型："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流水线类型："}},[t._v("#")]),t._v(" 流水线类型：")]),t._v(" "),s("ul",[s("li",[t._v("基本流水线")]),t._v(" "),s("li",[t._v("DAG流水线 （一个项目同时部署多个平台，多条流水线并行执行）")]),t._v(" "),s("li",[t._v("多项目流水线")]),t._v(" "),s("li",[t._v("父子流水线")]),t._v(" "),s("li",[t._v("合并请求流水线")])]),t._v(" "),s("h3",{attrs:{id:"流水线的触发："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流水线的触发："}},[t._v("#")]),t._v(" 流水线的触发：")]),t._v(" "),s("ul",[s("li",[t._v("推送代码")]),t._v(" "),s("li",[t._v("定时触发")]),t._v(" "),s("li",[t._v("url触发")]),t._v(" "),s("li",[t._v("手动触发")])]),t._v(" "),s("h4",{attrs:{id:"定时触发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定时触发"}},[t._v("#")]),t._v(" 定时触发")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/b7cd1a45b1c1410d864fa6d69c19253b.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"定时触发"}})]),t._v(" "),s("h4",{attrs:{id:"url触发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#url触发"}},[t._v("#")]),t._v(" url触发")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/a60a1d8830114fcfb662f29d19fb2d5f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"url触发"}})]),t._v(" "),s("h2",{attrs:{id:"流水线最佳实践及调试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流水线最佳实践及调试"}},[t._v("#")]),t._v(" 流水线最佳实践及调试")]),t._v(" "),s("p",[t._v("使用关键词：")]),t._v(" "),s("ul",[s("li",[t._v("interruptible：设置为true，标记该任务可被阻断。")]),t._v(" "),s("li",[t._v("release")]),t._v(" "),s("li",[t._v("timeout")]),t._v(" "),s("li",[t._v("resource_group")])]),t._v(" "),s("p",[t._v("涉及功能：")]),t._v(" "),s("ul",[s("li",[t._v("自动取消旧的流水线")]),t._v(" "),s("li",[t._v("创建一个release")]),t._v(" "),s("li",[t._v("设置超时时间")]),t._v(" "),s("li",[t._v("保证安全部署，一个分支只允许有一个部署任务")]),t._v(" "),s("li",[t._v("流水线的调试")]),t._v(" "),s("li",[t._v("设置部署冻结")]),t._v(" "),s("li",[t._v("流水线内置的调试")])]),t._v(" "),s("h3",{attrs:{id:"_1】自动取消旧的流水线"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1】自动取消旧的流水线"}},[t._v("#")]),t._v(" 1】自动取消旧的流水线")]),t._v(" "),s("p",[s("strong",[t._v("在同一个分支，短时间内只对最新的提交进行ci，取消未执行完的流水线。")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/b9a1d608178345c58c10e66b5d25e680.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"interruptible"}})]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install_job")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start install'\n\t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep 60\n\t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo  'end install'\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interruptible")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n\t  \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build_job")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n \t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start build'\n \t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep 120\n \t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'end build'\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interruptible")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("  \n \t\n")])])]),s("p",[t._v("第一次提交：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/373b48c722234a199175387b32cc9397.png",alt:"first"}})]),t._v(" "),s("p",[t._v("紧接着提交第二次：（"),s("strong",[t._v("上一次的ci就被取消了")]),t._v("）")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/6d321f9153524cf2948c22e485c2d74c.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"second"}})]),t._v(" "),s("h3",{attrs:{id:"_2】创建一个release"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2】创建一个release"}},[t._v("#")]),t._v(" 2】创建一个release")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/eb6f063aefad414f8c4ff47e5720cb83.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTIyMTAzNg==,size_16,color_FFFFFF,t_70",alt:"release"}})]),t._v(" "),s("p",[t._v("自动创建一个release：（release就是包，流水线中使用"),s("strong",[t._v("release")]),t._v("关键词）")]),t._v(" "),s("ul",[s("li",[t._v("使用gitlab提供的镜像进行打release")]),t._v(" "),s("li",[t._v("only指定触发任务的方式，当打tag时就会创建release")])]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("create_release")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" registry.gitlab.com/gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("org/release"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" echo 'start create release'\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("release")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tag_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $CI_COMMIT_TAG\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'my release'")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" tags\n")])])]),s("h3",{attrs:{id:"_3】设置超时时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3】设置超时时间"}},[t._v("#")]),t._v(" 3】设置超时时间")]),t._v(" "),s("p",[t._v("官方默认的超时时间是一个小时（如果需要自定义的话需要使用"),s("strong",[t._v("timeout")]),t._v("关键字）")]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build.sh\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3 hours 30 minutes\n\t\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rspec\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3h 30m\n")])])]),s("h3",{attrs:{id:"_4】限定并发任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4】限定并发任务"}},[t._v("#")]),t._v(" 4】限定并发任务")]),t._v(" "),s("p",[s("strong",[t._v("保证安全部署，一个分支只允许有一个部署任务(流水线)")])]),t._v(" "),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" staging\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo 'start deploy'\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep 120\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resource_group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prod\n")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);